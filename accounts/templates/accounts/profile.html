{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<div class="container mt-1">

  <h2 class="mb-4 fw-light" style="color: #2d4739;"><i class="bi bi-person-fill me-2"></i> <strong>Profile Dashboard</strong></h2>

    <ul class="nav nav-tabs mb-4 border-bottom" id="profileTabs" role="tablist">
      <li class="nav-item">
        <a class="nav-link {% if active_tab == 'profile' or not active_tab %}active{% endif %}" id="profile-tab" data-bs-toggle="tab" href="#profile" role="tab">Profile Info</a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if active_tab == 'nutrition' %}active{% endif %}" id="nutrition-tab" data-bs-toggle="tab" href="#nutrition" role="tab">Nutrition Targets</a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if active_tab == 'weight' %}active{% endif %}" id="weight-tab" data-bs-toggle="tab" href="#weight" role="tab">Weight Progress</a>
      </li>
    </ul>

  <div class="tab-content" id="profileTabsContent">

    <!-- ‚úÖ Profile Info Tab -->
    <div class="tab-pane fade" id="profile" role="tabpanel">
      <div class="caloriescont">
        <form method="POST">
          {% csrf_token %}
          <div class="row g-4 align-items-end">
            <div class="col-md-4">
              <label class="form-label">Username</label>
              {{ form.username|add_class:"form-control" }}
            </div>
            <div class="col-md-4">
              <label class="form-label">Email address</label>
              {{ form.email|add_class:"form-control" }}
            </div>
            <div class="col-md-4">
              <label class="form-label invisible">Change Password</label>
              <a href="{% url 'password_change' %}" class="btn btn-soft w-100">üîí Change Password</a>
            </div>
          </div>

          <div class="mt-4">
            <button type="submit" class="btn whoop">‚úÖ Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ‚úÖ Nutrition Tab -->
    <div class="tab-pane fade" id="nutrition" role="tabpanel">
      <div class="caloriescont">
        <p class="mb-3">
          <strong>üí° Basal Metabolic Rate:</strong><br>
          {{ targets.bmr }} kcal/day ‚Äî the energy your body burns at rest.
        </p>

        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">üéØ Daily Nutrition Targets</h5>
          <a href="{% url 'calorie_setup' %}" class="btn btn-soft">üîÅ Recalculate Goals</a>
        </div>

        <div class="bg-warning bg-opacity-10 rounded p-3 text-center mb-3">
          <h3 class="fw-bold mb-0">üî• {{ targets.calories }} Kcal</h3>
          <small class="text-muted">Your daily calorie target</small>
        </div>


        <div class="d-flex justify-content-around text-center mt-4">
          <div class="macro-box">
            <span class="macro-label">üçó Protein</span><br>
            <span class="macro-value">{{ total_protein|floatformat:1 }} / {{ targets.protein|floatformat:1 }} g</span>
          </div>
          <div class="macro-box">
            <span class="macro-label">ü•ë Fat</span><br>
            <span class="macro-value">{{ total_fat|floatformat:1 }} / {{ targets.fat|floatformat:1 }} g</span>
          </div>
          <div class="macro-box">
            <span class="macro-label">üçû Carbs</span><br>
            <span class="macro-value">{{ total_carbs|floatformat:1 }} / {{ targets.carbs|floatformat:1 }} g</span>
          </div>
        </div>
    </div>
  </div>

<!-- ‚úÖ Weight Progress Tab -->
<div class="tab-pane fade" id="weight" role="tabpanel">
  <div class="caloriescont px-3 pt-3 pb-4" >
    {% if weight_entries %}
      <!-- Add Weight Entry Form -->
    <form method="POST" class="row g-3 align-items-center mb-4">
      {% csrf_token %}
      <div class="col-auto">
        <label for="id_weight" class="col-form-label">Weight:</label>
      </div>
      <div class="col">
        {{ weight_form.weight|add_class:"form-control w-90" }}
          {% if weight_form.weight.errors %}
            <div class="text-danger small mt-1">
                {{ weight_form.weight.errors.0 }}
            </div>
          {% endif %}
      </div>
      <div class="col-auto">
        <button class="btn btn-soft" name="weight_entry">‚ûï Add</button>
      </div>
    </form>


      <!-- Chart Display -->
      <canvas id="weightChart" height="120px"></canvas>

      <!-- Download PDF Form (Moved Below) -->
    <form method="get" action="{% url 'download_weight_pdf' %}" class="row g-3 align-items-end mt-4">
      <div class="col">
        <label class="form-label">From:</label>
        <input type="date" name="start_date" class="form-control" required>
      </div>
      <div class="col">
        <label class="form-label">To:</label>
        <input type="date" name="end_date" class="form-control" required>
      </div>
      <div class="col-auto d-flex align-items-end">
        <button type="submit" class="btn btn-soft d-inline-flex align-items-center justify-content-center px-4 py-2">
          üì• Download PDF
        </button>
      </div>
    </form>

    {% else %}
      <p class="text-muted">No weight entries found. Start tracking to see your progress.</p>
    {% endif %}
  </div>
</div>


<!-- ‚úÖ Chart.js for weight graph -->

<!-- ‚úÖ Include Chart.js only once -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // ‚úÖ Weight Chart
  const weightChart = document.getElementById('weightChart');
  {% if weight_entries %}
  new Chart(weightChart, {
    type: 'line',
    data: {
      labels: [{% for entry in weight_entries %}"{{ entry.date|date:'M j' }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        label: 'Weight (kg)',
        data: [{% for entry in weight_entries %}{{ entry.weight }}{% if not forloop.last %}, {% endif %}{% endfor %}],
        fill: true,
        borderColor: '#f06292',
        backgroundColor: 'rgba(240,98,146,0.2)',
        tension: 0.4
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: false }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });
  {% endif %}
</script>
<script>
  // ‚úÖ Save active tab to localStorage
  document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(tab => {
    tab.addEventListener('shown.bs.tab', function (e) {
      localStorage.setItem('activeTab', e.target.getAttribute('href'));
    });
  });

  // ‚úÖ On page load, restore last active tab
  document.addEventListener('DOMContentLoaded', function () {
    const activeTab = localStorage.getItem('activeTab');
    if (activeTab) {
      const tabTrigger = document.querySelector(`a[href="${activeTab}"]`);
      if (tabTrigger) {
        new bootstrap.Tab(tabTrigger).show();
      }
    }
  });
      // Ja ir tikai viens alerts aktƒ´vs (Bootstrap), saglabƒÅ aktƒ´vo tab pirms nos≈´tƒ´≈°anas
    document.querySelectorAll('form').forEach(form => {
      form.addEventListener('submit', () => {
        const activeTab = document.querySelector('.nav-link.active');
        if (activeTab) {
          localStorage.setItem('activeTab', activeTab.getAttribute('href'));
        }
      });
    });

</script>

{% endblock %}
